```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¡”ç½—è¿·å®« V2.7 - å‘½è¿å…¨å…¸</title>
    <style>
        :root { --p-color: #00ffcc; --bg-dark: #050505; --accent: #ffd700; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; }
        body { background: var(--bg-dark); color: #eee; font-family: 'Courier New', monospace; margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 12px; overflow: auto; }
        
        /* åŠ¨ç”» */
        .shake { animation: shake 0.2s; }
        @keyframes shake { 0%,100% {transform:translateX(0)} 25% {transform:translateX(-5px)} 75% {transform:translateX(5px)} }
        .inverted-active { filter: invert(1) hue-rotate(180deg); }

        #battle-bg { position: fixed; inset: 0; z-index: -1; background-size: cover; background-position: center; filter: brightness(0.25); transition: 1s; }

        /* å…¨å±å¼¹çª— */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .card-node { padding: 15px; border: 1px solid #444; background: #111; margin: 10px; width: 280px; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .card-node:hover { border-color: var(--accent); background: #222; }

        /* é€‰æ‹©ç•Œé¢ä¸¤åˆ—å¸ƒå±€ */
        #select-layer { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
        #select-layer .card-node { width:45%; max-width:280px; }

        /* ä¸»UI */
        #game-ui { display: none; flex-direction: column; height: auto; padding: 10px; max-width: 500px; width: 100%; margin: 0 auto; max-height: calc(100vh - 24px); overflow: auto; border-radius: 8px; }
        .stats-bar { display: flex; justify-content: space-between; font-size: 12px; padding: 10px; border: 1px solid #333; background: #111; }
        
        .boss-box { padding: 10px; text-align: center; }
        .portrait { width: 120px; height: 120px; border-radius: 50%; border: 2px solid #333; margin: 0 auto; overflow: hidden; background: #000; }
        .portrait img { width: 100%; height: 100%; object-fit: cover; }
        
        .hp-wrap { width: 100%; height: 10px; background: #200; border-radius: 5px; margin: 10px 0; overflow: hidden; position: relative; }
        #b-hp-fill { height: 100%; background: #ff4444; transition: 0.3s; }
        #b-shield-fill { position: absolute; top:0; left:0; height: 100%; background: #55aaff; transition: 0.3s; }

        .log { max-height: 220px; overflow-y: auto; background: rgba(0,0,0,0.6); padding: 10px; font-size: 13px; margin: 10px 0; border: 1px solid #222; line-height: 1.4; }
        
        .hand { display: flex; gap: 5px; justify-content: center; height: 130px; }
        .card { width: 32%; border: 1px solid #555; background: #1a1a1a; padding: 5px; display: flex; flex-direction: column; justify-content: space-between; font-size: 11px; text-align: center; cursor: pointer; }
        .card.inverted { border: 1px solid #ff0055; background: #300; box-shadow: 0 0 10px #ff0055; }
        
        .btn-refresh { width: 100%; padding: 10px; margin-top: 10px; background: #222; border: 1px solid #444; color: #888; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="battle-bg"></div>

    <!-- é€‰è§’å±‚ -->
    <div id="select-layer" class="overlay">
        <h2 style="color:var(--accent); letter-spacing: 4px;">äººæ ¼è§‰é†’</h2>
        <div class="card-node" onclick="(async function(){try{await SFX.init(); SFX.attack(); addLog('éŸ³æ•ˆå·²å¯ç”¨','green')}catch(e){console.warn(e)}})()"><b style="color:#aaffff">å¯ç”¨éŸ³æ•ˆ</b><br><small>ç‚¹å‡»ä»¥å¯ç”¨éŸ³æ•ˆ</small></div>
        <div class="card-node" onclick="initGame('INTP')"><b style="color:#ff00ff">INTP éšå£«</b><br><small>é€»è¾‘æ¨æ–­ Â· çˆ†å‘è¾“å‡º</small></div>
        <div class="card-node" onclick="initGame('ENFP')"><b style="color:#ffea00">ENFP æ„šè€…</b><br><small>çƒ­æƒ…ç«èŠ± Â· éšæœºå¥‡è¿¹</small></div>
        <div class="card-node" onclick="initGame('ISFP')"><b style="color:#00ffcc">ISFP æ˜Ÿæ˜Ÿ</b><br><small>æµä½“è‰ºæœ¯ Â· èŠ‚å¥å›è¡€</small></div>
        <div class="card-node" onclick="initGame('INTJ')"><b style="color:#4a90e2">INTJ ç­–å£«</b><br><small>ä¸“æ³¨å¸ƒå±€ Â· æˆ˜æœ¯æŠ¤ç›¾</small></div>
        <div class="card-node" onclick="initGame('ENFJ')"><b style="color:#ff7e5f">ENFJ ç»Ÿå¸…</b><br><small>å…±é¸£é¼“èˆ Â· å›¢ä½“å¢ç›Š</small></div>
        <div class="card-node" onclick="initGame('INFJ')"><b style="color:#8e44ad">INFJ æå€¡è€…</b><br><small>é¢„è¨€ Â· çµè§‰ Â· å¸è¡€</small></div>
    </div>

    <!-- ç»“å±€å±‚ï¼šæœªå®Œå¾…ç»­ -->
    <div id="ending-layer" class="overlay" style="display:none">
        <h2 style="color:var(--accent); letter-spacing: 6px; font-size:28px;">ç»ˆå±€ï¼šæ„è¯†çš„è¾¹ç•Œ</h2>
        <p style="color:#ccc; max-width:560px;">åœ¨ç©¿è¶Šäº†æ‰€æœ‰ç»´åº¦ä¸è¯•ç‚¼ä¹‹åï¼Œæ„è¯†æŠµè¾¾äº†ä¸€ä¸ªè£‚ç¼ã€‚å…‰èŠ’æ˜ ç…§ä¸‹çš„è®°å¿†ç¢ç‰‡çº·çº·è¿œå»ï¼Œè€ŒçœŸæ­£çš„è°œé¢˜æ‰åˆšåˆšè‹é†’â€¦â€¦</p>
        <p style="color:#ffd700; font-size:18px;">æœªå®Œå¾…ç»­</p>
        <div class="card-node" onclick="(function(){document.getElementById('ending-layer').style.display='none'; location.reload();})()">é‡æ–°å¼€å§‹</div>
    </div>

    <!-- äº‹ä»¶å±‚ -->
    <div id="event-layer" class="overlay" style="display:none">
        <h3 id="event-title" style="color:var(--accent)">å‘½è¿ä¹‹è½®</h3>
        <p id="event-desc" style="padding: 0 20px; color: #ccc;"></p>
        <div id="event-options"></div>
    </div>

  <!-- å¥–åŠ±å±‚ï¼šåŠ¨æ€ç”Ÿæˆé€‰é¡¹ -->
    <div id="reward-layer" class="overlay" style="display:none">
        <h3 style="color:var(--accent); letter-spacing: 2px;">ç»´åº¦é‡æ„</h3>
        <p style="font-size: 12px; color: #888;">å‡»è´¥å¼ºæ•Œï¼Œä½ çš„æ„è¯†å¾—åˆ°äº†è¿›åŒ–...</p>
        <div id="reward-options-container" style="display: flex; flex-direction: column; align-items: center;">
            <!-- é€‰é¡¹å°†ç”± JS åŠ¨æ€æ³¨å…¥ -->
        </div>
    </div>
```

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-ui">
        <div class="stats-bar">
            <div style="display:flex; flex-direction:column; gap:6px;">
                <div>â¤ï¸ <span id="p-hp"></span>/<span id="p-max-hp"></span></div>
                <div style="width:140px;">
                    <div style="font-size:10px; color:#888;">æŠ¤ç›¾</div>
                    <div style="width:100%; height:8px; background:#111; border:1px solid #222; border-radius:6px; overflow:hidden;">
                        <div id="p-shield-fill" style="height:100%; background:#55aaff; width:0%; transition:0.25s;"></div>
                    </div>
                </div>
            </div>
                <div>ğŸ›¡ï¸ <span id="p-shield">0</span></div>
                <div id="res-tag">âœ¨ 0</div>
                <div>LAYER <span id="level-tag">1</span></div>
                <div id="inv-badge" style="font-size:12px; padding:4px 8px; border-radius:6px; background:rgba(255,255,255,0.03); color:#ccc; align-self:center;">é€†ä½ï¼šå¯ç”¨</div>
        </div>

        <div class="boss-box">
            <div class="portrait"><img id="b-img" src=""></div>
            <div id="b-name" style="color:#ff4444; font-size:14px; margin:5px 0;"></div>
            <div id="b-hp-text" style="font-size:12px; color:#fff; margin-bottom:6px;"></div>
            <div style="font-size:10px; color:#55aaff">ğŸ›¡ï¸ æŠ¤ç›¾: <span id="b-shield-val">0</span></div>
            <div class="hp-wrap">
                <div id="b-hp-fill"></div>
                <div id="b-shield-fill"></div>
            </div>
        </div>

        <div class="log" id="log"></div>

        <div class="hand" id="hand"></div>
        <button class="btn-refresh" onclick="sacrifice()">ğŸ©¸ ç‰ºç‰² 10HP é‡æ„æ‰‹ç‰Œ</button>
        
    </div>

<script>
    // ZzFX - è¶…è½»é‡çº§å¤å¤éŸ³æ•ˆå¼•æ“ï¼ˆåµŒå…¥ï¼‰
    const zzfxV=.3,zzfx=([...t])=>{{let e,n,a,r,o,i,s,l,d,c,u,h,g,p,f,m,b,y,v,M,x=2*Math.PI,k=44100,z=t[0],P=t[1],S=t[2],T=t[3],j=t[4],w=t[5],A=t[6],B=t[7],C=t[8],D=t[9],E=t[10],F=t[11],G=t[12],H=t[13],I=t[14],L=t[15],N=t[16],O=t[17],R=t[18],U=t[19],X=Math.max(.001,T+j+w+A+B),Y=S+Math.PI/2,q=x*C/k,W=x*D/k,J=0,K=0,Q=0,V=1,Z=0,_=0,$=0,aa=new Float32Array(k*X);for(n=0;n<k*X;++n){if(++Z>=(u=Math.floor(k*Math.max(.001,F)))){for(Z=0,h=u,g=0;g<16;++g)h+=Math.floor(k*Math.max(.001,t[20+g]));V=1/h}if(i=Math.min(1,n/k/T),s=Math.min(1,(X-n/k)/B),l=n/k<T+j?i:n/k<T+j+w?1:s,l=L?Math.floor(l*L)/L:l,d=Math.cos(n/k*x*E+Y),c=Math.sin(q*n+W*Math.sin(Q*n+R)+aa[n-u]*N+d*O),v=Math.sin(x*n/k*V+aa[n-u]*I+c),M=Math.exp(-Math.abs(U)*5)*v,aa[n]=M*l*zzfxV,++J>=Math.floor(k*G))for(J=0,aa[n]=0,Q=0,g=0;g<16;++g)Q+=Math.floor(k*Math.max(.001,t[20+g]));Q=x*Q/k}const ba = window.zzfxAudioCtx || (window.zzfxAudioCtx = new (window.AudioContext||window.webkitAudioContext)());const ca=ba.createBuffer(1,aa.length,k);ca.getChannelData(0).set(aa);const da=ba.createBufferSource();da.buffer=ca,da.connect(ba.destination),da.start()}}

    // SFX åº“ï¼ˆ16-bit é£æ ¼ï¼‰
    const SFX = {
        // åˆå§‹åŒ–ï¼šåˆ›å»ºå…±äº« AudioContextï¼Œå¹¶åœ¨é¦–æ¬¡ç”¨æˆ·äº¤äº’æ—¶å°è¯• resumeï¼ˆä»¥æ»¡è¶³æµè§ˆå™¨ç­–ç•¥ï¼‰
        init: async function(){
            if(!window.zzfxAudioCtx){
                try{ window.zzfxAudioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ console.warn('AudioContext åˆ›å»ºå¤±è´¥', e); }
            }
            try{
                if(window.zzfxAudioCtx && window.zzfxAudioCtx.state === 'suspended') await window.zzfxAudioCtx.resume();
                addLog('éŸ³æ•ˆå·²å¯ç”¨', 'green');
                // ç«‹å³æ’­æ”¾ä¸€ä¸ªçŸ­ä¿ƒçš„æµ‹è¯•æŒ¯è¡å™¨ï¼Œä¾¿äºç¡®è®¤æµè§ˆå™¨å…è®¸è¾“å‡º
                try{
                    const ctx = window.zzfxAudioCtx;
                    if(ctx){
                        const g = ctx.createGain(); g.gain.value = 0.12;
                        const o = ctx.createOscillator(); o.type = 'sine'; o.frequency.value = 660;
                        o.connect(g); g.connect(ctx.destination);
                        o.start();
                        setTimeout(()=>{ try{ o.stop(); g.disconnect(); }catch(e){} }, 140);
                    }
                }catch(err){ console.warn('æµ‹è¯•æŒ¯è¡å™¨æ’­æ”¾å¤±è´¥', err); }
            }catch(e){
                // å¦‚æœç›´æ¥ resume å¤±è´¥ï¼ˆéç”¨æˆ·æ‰‹åŠ¿ï¼‰ï¼Œé€€å›åˆ°ç›‘å¬äº¤äº’ä»¥ä¾¿ç¨å resume å¹¶æ’­æ”¾æµ‹è¯•éŸ³
                const resumeHandler = async () => {
                    try{ if(window.zzfxAudioCtx && window.zzfxAudioCtx.state === 'suspended') await window.zzfxAudioCtx.resume(); addLog('éŸ³æ•ˆå·²å¯ç”¨', 'green');
                        try{ const ctx = window.zzfxAudioCtx; if(ctx){ const g = ctx.createGain(); g.gain.value = 0.12; const o = ctx.createOscillator(); o.type='sine'; o.frequency.value=660; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ try{o.stop(); g.disconnect();}catch(e){} },140); } }catch(err2){console.warn('æµ‹è¯•æŒ¯è¡å™¨å¤±è´¥',err2)}
                    }catch(err){ console.warn('éŸ³æ•ˆå¯ç”¨å¤±è´¥', err); }
                    window.removeEventListener('pointerdown', resumeHandler);
                };
                window.addEventListener('pointerdown', resumeHandler);
            }
        },
        // å¤‡ç”¨æŒ¯è¡å™¨ï¼šæ”¯æŒæ³¢å½¢ç±»å‹
        _beep: (freq=440, dur=120, vol=0.08, type='sine') => {
            try{
                const ctx = window.zzfxAudioCtx || (window.zzfxAudioCtx = new (window.AudioContext||window.webkitAudioContext)());
                const g = ctx.createGain(); g.gain.value = vol;
                const o = ctx.createOscillator(); o.type = type; o.frequency.value = freq;
                const env = ctx.createGain(); env.gain.value = 1;
                o.connect(env); env.connect(g); g.connect(ctx.destination);
                o.start();
                // çº¿æ€§è¡°å‡ä»¥é¿å…çªå…€çš„åœæ­¢
                env.gain.linearRampToValueAtTime(0.0001, ctx.currentTime + dur/1000);
                setTimeout(()=>{ try{ o.stop(); g.disconnect(); env.disconnect(); }catch(e){} }, dur+20);
            }catch(e){ console.warn('SFX._beep error', e); }
        },
        attack: () => { try{ zzfx([.9,.5,420,.02,.03,.12,1,1.4,6.5,-2,0,0,0,0,0,0,0,.12,.02,0]); }catch(e){}; SFX._beep(620,90,0.08,'square'); },
        magic: () => { try{ zzfx([1.4, undefined, 380, .02, .12, .22, 1, 1.05, 9, undefined, undefined, undefined, undefined, undefined, .12, undefined, .35, .02, undefined, undefined]); }catch(e){}; SFX._beep(460,140,0.06,'sawtooth'); },
        heal: () => { try{ zzfx([1.1,.08,600,.06,.45,.9,0,1.8,0,0,350,.08,0,0,0,0,0,.45,.08,0]); }catch(e){}; SFX._beep(780,200,0.06,'triangle'); },
        hurt: () => { try{ zzfx([1.6, undefined, 130, .04, .03, .18, 4, 2.4, 1.3, undefined, undefined, undefined, undefined, 1.6, undefined, .12, undefined, .85, .06, undefined]); }catch(e){}; SFX._beep(200,180,0.12,'sawtooth'); },
        awaken: () => { try{ zzfx([2.1, undefined, 12, .01, .18, .65, 4, 3.2, undefined, .1, undefined, undefined, .12, 1.6, undefined, .5, undefined, .6, .02, undefined]); }catch(e){}; SFX._beep(880,220,0.05,'sine'); }
    };
    // SFX.init å°†ä»…ç”±ç”¨æˆ·æ“ä½œè§¦å‘ï¼ˆä¾‹å¦‚â€œå¯ç”¨éŸ³æ•ˆâ€æŒ‰é’®ï¼‰

    // INFJ ä¸“å±éŸ³æ•ˆï¼ˆç©ºçµ / å›å£°ï¼‰ï¼ŒåŒæ—¶è§¦å‘å¤‡ç”¨æŒ¯è¡å™¨ä»¥ç¡®ä¿å¯å¬
    const INFJ_SFX = {
        visionUp: () => { try{ zzfx([1.2, .02, 1400, .01, .06, .12, 0, .7, 40, undefined, undefined, undefined, undefined, 1.2, undefined, .08, undefined, .6, .01, undefined]); }catch(e){console.warn(e)}; SFX._beep(1200,180,0.06,'triangle'); },
        revelation: () => { try{ zzfx([1.6, .03, 520, .02, .18, .42, 1, 2.6, undefined, .45, 120, .04, .06, undefined, undefined, undefined, undefined, .9, .02, undefined]); }catch(e){console.warn(e)}; SFX._beep(880,260,0.05,'sine'); }
    };

    const CHARS = {
        INTP: { hp: 80, res: "é€»è¾‘", color: "#ff00ff", cards: [
            { n: "æ¨æ¼”", d: 12, c: 1, txt: "+1é€»è¾‘" },
            { n: "åˆ†æ", d: 6, c: 2, txt: "+2é€»è¾‘" },
            { n: "ç»“è®º", d: 35, c: -3, txt: "-3é€»è¾‘çˆ†å‘" }
        ], inv: { n: "é€†Â·æ‚–è®º", d: 55, c: 0, txt: "æ— æ¶ˆè€—çˆ†å‘" } },
        ENFP: { hp: 100, res: "çƒ­æƒ…", color: "#ffea00", cards: [
            { n: "ç«èŠ±", d: [5,25], c: 1, txt: "+1çƒ­æƒ…" },
            { n: "æ¼«æ¸¸", d: 15, c: 1, txt: "+1çƒ­æƒ…" },
            { n: "ç‹‚æƒ³", d: [10,60], c: -2, txt: "-2çƒ­æƒ…çˆ†å‘" }
        ], inv: { n: "é€†Â·æå…‰", d: [40,80], c: 0, txt: "éšæœºæ€§å·…å³°" } },
        ISFP: { hp: 90, res: "æµ", color: "#00ffcc", cards: [
            { n: "ç´ æ", d: 11, c: 1, txt: "+1æµ" },
            { n: "è°ƒè‰²", d: 8, c: 1, txt: "+1æµ/å›è¡€8", h: 8 },
            { n: "æ°ä½œ", d: 25, c: -1, txt: "-1æµç¨³å®š" }
        ], inv: { n: "é€†Â·ç¥å¯", d: 25, c: 0, txt: "å›è¡€20", h: 20 } }
        ,
        INTJ: { 
            hp: 75, res: "ä¸“æ³¨", color: "#4a90e2",
            cards: [
                { n: "è§‚å¯Ÿ", d: 8, c: 1, txt: "ä¼¤å®³æ°¸ä¹…+2", f: (p) => { p.dmgMod += 0.1; } },
                { n: "å¸ƒå±€", d: 5, c: 2, txt: "è·å¾—10æŠ¤ç›¾", f: (p) => { p.shield = (p.shield || 0) + 10; } },
                { n: "å°†å†›", d: 30, c: -3, txt: "ç ´ç›¾åŒå€" }
            ],
            inv: { n: "é€†Â·ä¸–ç•Œ", d: 60, c: 0, txt: "æ‘§æ¯æŠ¤ç›¾" }
        },
        ENFJ: {
            hp: 120, res: "å…±é¸£", color: "#ff7e5f",
            cards: [
                { n: "é¼“èˆ", d: 10, c: 1, h: 5, txt: "å›è¡€5" },
                { n: "ç»Ÿåˆ", d: 15, c: 1, txt: "å‡ä¼¤é˜²å¾¡", f: (p) => { p.tempDamageReduction = (p.tempDamageReduction||0) + 0.3; addLog("ç»Ÿåˆï¼šæœ¬æ¬¡å‡å°‘30%å—åˆ°ä¼¤å®³", "green"); } },
                { n: "çƒˆé˜³", d: 25, c: -2, txt: "ç”Ÿå‘½åŠ æˆ", f: (p) => { return Math.floor(p.hp * 0.2); } }
            ],
            inv: { n: "é€†Â·æ—¥èš€", d: 70, c: 0, txt: "çŒ®ç¥­çˆ†å‘", f: (p) => { p.hp = Math.max(1, p.hp - 15); p.nextIgnoreBossShield = true; addLog("é€†Â·æ—¥èš€ï¼šä»¥è¡€ä¸ºç¥­ï¼Œç©¿é€æŠ¤ç›¾ï¼", "#ff7e5f"); return 50; } }
        }
        ,
        INFJ: {
            hp: 90, res: "çµè§‰", color: "#8e44ad",
            cards: [
                { n: "å†¥æƒ³", d: 7, c: 1, txt: "+1è¿œè§", f: (p) => { p.vision = (p.vision || 0) + 1; addLog('è¿œè§ +1', '#8e44ad'); try{ INFJ_SFX.visionUp(); }catch(e){} } },
                { n: "å…±æƒ…", d: 12, c: 1, txt: "å—æŸåå¼¹", f: (p) => { if(p.tookDamageThisTurn){ boss.hp = Math.max(0, boss.hp - 15); addLog('å…±æƒ…åå¼¹ï¼šBoss -15', '#8e44ad'); try{ SFX.attack(); }catch(e){} } } },
                { n: "å¤©å¯", d: 22, c: -2, txt: "ç©¿é€æŠ¤ç›¾", f: (p) => { p.vision = (p.vision || 0) + 1; p.nextIgnoreBossShield = true; addLog('å¤©å¯ï¼šè¿œè§ +1ï¼Œä¸‹ä¸€æ¬¡ç©¿é€æŠ¤ç›¾', '#8e44ad'); try{ INFJ_SFX.revelation(); }catch(e){} } }
            ],
            inv: { n: "é€†Â·æœˆäº®", d: 50, c: 0, txt: "å…ç–«ä¼¤å®³+æ»¡è¿œè§", f: (p) => { boss.isConfused = true; p.vision = (p.vision || 0) + 3; addLog('é€†Â·æœˆäº®ï¼šBoss è¿·èŒ«ï¼Œæœ¬å›åˆæ— æ³•é€ æˆä¼¤å®³ï¼›è¿œè§ +3', '#8e44ad'); try{ INFJ_SFX.revelation(); }catch(e){} return 50; } }
        }
    };

    const BOSSES = [
        { n: "æ„šè€… Â· æ··ä¹±", img: "assets/boss_0.png", bg: "assets/bg_0.png", desc: "æ¯3å›åˆé‡ç½®ä½ çš„èµ„æºã€‚" },
        { n: "éšå£« Â· å­¤å¯‚", img: "assets/boss_1.png", bg: "assets/bg_1.png", desc: "ã€å†¥æƒ³ã€‘æ¯å›åˆè·å¾—10ç‚¹æŠ¤ç›¾ã€‚" },
        { n: "æ•™çš‡ Â· æˆ’å¾‹", img: "assets/boss_2.png", bg: "assets/bg_2.png", desc: "ç¦æ­¢è¿ç»­ä½¿ç”¨åŒåå¡ã€‚" },
        { n: "æ­»ç¥ Â· ç»ˆç„‰", img: "assets/boss_3.png", bg: "assets/bg_3.png", desc: "æ¯å›åˆä¼¤å®³å¢åŠ 2ç‚¹ã€‚" }
    ];

    // 1. å®šä¹‰ä¸°å¯Œçš„å¥–åŠ±æ± 
    const REWARD_POOL = [
        { 
            id: 'growth', 
            n: "ç”Ÿå‘½é‡å¡‘ (Growth)", 
            d: "ç”Ÿå‘½ä¸Šé™ +30ï¼Œå¹¶ç«‹å³ä¿®å¤ 50HP", 
            f: () => { player.maxHp += 30; player.hp = Math.min(player.maxHp, player.hp + 50); } 
        },
        { 
            id: 'strength', 
            n: "åŠ›é‡è§‰é†’ (Strength)", 
            d: "å…¨å¡ç‰ŒåŸºç¡€ä¼¤å®³æ°¸ä¹…æå‡ 15%", 
            f: () => { player.dmgMod += 0.15; } 
        },
        { 
            id: 'temperance', 
            n: "èŠ‚åˆ¶ç²¾ç¥ (Temperance)", 
            d: "æ¯åœºæˆ˜æ–—å¼€å§‹æ—¶ï¼Œé¢å¤–è·å¾— 2 ç‚¹åˆå§‹èµ„æº", 
            f: () => { player.initialResBonus = (player.initialResBonus || 0) + 2; } 
        },
        { 
            id: 'devil', 
            n: "æ¶é­”äº¤æ˜“ (Devil)", 
            d: "é‡æ„æ‰‹ç‰Œçš„ç”Ÿå‘½ä»£ä»·ä» 10 é™è‡³ 5", 
            f: () => { player.sacrificeCost = 5; } 
        },
        { 
            id: 'star', 
            n: "æ˜Ÿè¾°æŒ‡å¼• (The Star)", 
            d: "ç«‹å³è¡¥æ»¡æ‰€æœ‰ç”Ÿå‘½å€¼ï¼Œä¸”èµ„æº +3", 
            f: () => { player.hp = player.maxHp; player.curRes += 3; } 
        },
        { 
            id: 'emperor', 
            n: "çš‡å¸å¨ä¸¥ (Emperor)", 
            d: "æœ¬å±€åç»­å—åˆ°çš„æ‰€æœ‰ä¼¤å®³å‡å°‘ 10%", 
            f: () => { player.receivedDmgMod *= 0.9; } 
        }
    ];

    let player = {}, boss = {}, level = 1;

    function initGame(type) {
        const d = CHARS[type];
        player = { 
            ...d, maxHp: d.hp, curRes: 0, lastCard: "", type: type,
            dmgMod: 1.0, receivedDmgMod: 1.0, luckMax: false, 
            perTurnEffects: [], nextCrit: false,
            shield: 0,
            invUsed: false
        };
        document.getElementById('select-layer').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        startLevel();
    }

    function startLevel() {
        triggerEvent();
    }

    function triggerEvent() {
        const layer = document.getElementById('event-layer');
        const opts = document.getElementById('event-options');
        layer.style.display = 'flex';
        opts.innerHTML = '';

        // æ•´åˆä½ æä¾›çš„ 13 ä¸ªéšæœºäº‹ä»¶
        const evs = [
            { t: "éšè€…çš„æŒ‡å¼•", d: "å¤±å» 5HPï¼Œè·å¾— 2 ç‚¹åˆå§‹èµ„æº", f: () => { player.hp -= 5; player.curRes += 2; } },
            { t: "å‘½è¿çš„è±ªèµŒ", d: "éšæœºæ¢å¤æˆ–å¤±å» 15HP", f: () => { player.hp += (Math.random() > 0.5 ? 15 : -15); } },
            { t: "ç©ºç™½å¡ç‰Œ", d: "æœ¬å…³ Boss åˆå§‹ç”Ÿå‘½å‡å°‘ 20%", f: () => { boss.hp *= 0.8; } },
            { t: "ä¸ç¨³å®šçš„é­”åŠ›", d: "éšæœºè·å¾— 1-5 ç‚¹èµ„æºï¼Œä½†æœ‰ 30% å‡ ç‡æ‰£é™¤ 10HP", f: () => { player.curRes += Math.floor(Math.random() * 5) + 1; if (Math.random() < 0.3) player.hp -= 10; } },
            { t: "å¼ºå¿ƒå‰‚", d: "HP æ¯å‡å°‘ 10%ï¼Œé€ æˆçš„ä¼¤å®³å¢åŠ  5%", f: () => { let loss = (1 - player.hp / player.maxHp); player.dmgMod += loss * 0.5; } },
            { t: "ç¥ç§˜å•†è´©", d: "æ¶ˆè€— 10HPï¼Œæ€ç»´é‡ç»„ï¼šæ”»å‡»åŠ›æå‡ 20%", f: () => { player.hp -= 10; player.dmgMod += 0.2; } },
            { t: "è™šå¼±è¯…å’’", d: "æœ¬å…³å—åˆ°çš„ä¼¤å®³å¢åŠ  50%ï¼Œä½†åˆå§‹èµ„æºç¿»å€", f: () => { player.receivedDmgMod *= 1.5; player.curRes *= 2; } },
            { t: "å¹¸è¿å¥³ç¥çš„å¾®ç¬‘", d: "æœ¬å…³æ‰€æœ‰éšæœºåˆ¤å®šè§†ä¸ºæœ€å¤§å€¼", f: () => { player.luckMax = true; } },
            { t: "æ—¶é—´å›æº¯", d: "æ¢å¤è‡³æœ€å¤§ HP çš„ 80%ï¼Œä½†ç”Ÿå‘½ä¸Šé™å‡å°‘ 10", f: () => { player.hp = player.maxHp * 0.8; player.maxHp -= 10; } },
            { t: "è¯…å’’å®ç®±", d: "è·å¾— 3 ç‚¹èµ„æºï¼Œä½†æ¯å›åˆæœ‰ 20% å‡ ç‡è‡ªåŠ¨æ‰£é™¤ 5HP", f: () => { player.curRes += 3; player.perTurnEffects.push(() => { if (Math.random() < 0.2) { player.hp -= 5; addLog("è¯…å’’å‘ä½œï¼š-5HP", "red"); } }); } },
            { t: "ç‹‚æˆ˜å£«ä¹‹è¡€", d: "æ”»å‡»åŠ›ç¿»å€ï¼Œä½†å—åˆ°çš„ä¼¤å®³ä¹Ÿç¿»å€", f: () => { player.dmgMod *= 2; player.receivedDmgMod *= 2; } },
            { t: "å‘½è¿çš„é¦ˆèµ ", d: "éšæœºè·å¾—ä¸€é¡¹æ­£é¢çŠ¶æ€ï¼ˆå¢ä¼¤/å›è¡€ï¼‰", f: () => { if(Math.random()>0.5){player.dmgMod += 0.1; addLog("è·å¾—å¢ä¼¤","green");} else {player.hp += 20; addLog("è·å¾—å›è¡€","green");} } },
            { t: "è™šæ— ä¹‹è§¦", d: "ä¸‹ä¸€æ¬¡æ”»å‡»å¿…å®šåŒå€ä¼¤å®³ï¼Œä½†æ¶ˆè€—å½“å‰ä¸€åŠçš„ HP", f: () => { player.nextCrit = true; player.hp = Math.floor(player.hp / 2); } }
        ];
        
        const ev = evs[Math.floor(Math.random()*evs.length)];
        document.getElementById('event-title').innerText = ev.t;
        document.getElementById('event-desc').innerText = ev.d;
        
        const btn = document.createElement('div');
        btn.className = 'card-node';
        btn.innerText = "æ¥å—å‘½è¿";
        btn.onclick = () => {
            ev.f();
            layer.style.display = 'none';
            initBattle();
        };
        opts.appendChild(btn);
    }

    function initBattle() {
        const bData = BOSSES[Math.min(level-1, 3)];
        boss = { 
            ...bData, 
            hp: 50 + level*40, maxHp: 50 + level*40, 
            dmg: 5 + level*2, shield: 0, turn: 0 
        };

        // æ¯åœºæˆ˜æ–—é‡ç½®é€†ä½ä½¿ç”¨æ ‡å¿—
        player.invUsed = false;
        // åº”ç”¨â€œèŠ‚åˆ¶â€å¥–åŠ±ï¼šåˆå§‹èµ„æº
        if(player.initialResBonus) player.curRes += player.initialResBonus;

        document.getElementById('b-img').src = bData.img;
        document.getElementById('battle-bg').style.backgroundImage = `url('${bData.bg}')`;
        addLog(`--- LAYER ${level} : ${boss.n} ---`, varColor());
        addLog(`ç‰¹æ€§: ${boss.desc}`, "#aaa");
        updateUI();
        initHand();
    }

    function initHand() {
        const h = document.getElementById('hand');
        h.innerHTML = '';
        // æœ¬å›åˆæ˜¯å¦å·²ç»å—åˆ°è¿‡ä¼¤å®³ï¼ˆä¾›å…±æƒ…ç­‰åˆ¤å®šä½¿ç”¨ï¼‰
        player.tookDamageThisTurn = false;
        const isInverted = (player.hp / player.maxHp) < 0.3;
        
        if(isInverted) {
            document.body.classList.add('inverted-active');
            addLog("!! é€†ä½è§‰é†’ï¼šæ€ç»´åå¡Œä¸­ !!", "#ff0055");
            try{ SFX.awaken(); }catch(e){console.warn('SFX error',e)}
        } else {
            document.body.classList.remove('inverted-active');
        }

        for(let i=0; i<3; i++) {
            let card = (isInverted && i === 1) ? { ...player.inv, isInverted: true } : { ...player.cards[Math.floor(Math.random()*player.cards.length)] };
            const el = document.createElement('div');
            el.className = `card ${card.isInverted ? 'inverted' : ''}`;
            
            let dVal;
            if (Array.isArray(card.d)) {
                dVal = player.luckMax ? card.d[1] : `${card.d[0]}-${card.d[1]}`;
            } else {
                dVal = card.d;
            }

            el.innerHTML = `<b>${card.n}</b><br><small>${card.txt || ''}</small>
                            <div style="color:#ff4444">âš”ï¸ ${dVal}</div>
                            <div style="color:var(--p-color)">${card.c>=0?'+':''}${card.c}</div>`;
            el.onclick = () => playCard(card);
            h.appendChild(el);
        }
    }

    function playCard(card) {
        if(!card.isInverted && card.c < 0 && player.curRes < Math.abs(card.c)) return addLog("èƒ½é‡ä¸è¶³", "#555");
        // é™åˆ¶ï¼šæ¯ä¸ª Boss åªå…è®¸ä½¿ç”¨ä¸€æ¬¡é€†ä½ï¼ˆinvï¼‰æŠ€èƒ½
        if(card.isInverted) {
            if(player.invUsed) return addLog("é€†ä½æŠ€èƒ½æœ¬åœºå·²ç”¨è¿‡", "#555");
            player.invUsed = true; // æ ‡è®°å·²ä½¿ç”¨ï¼Œç›´è‡³ä¸‹ä¸€åœºæˆ˜æ–—é‡ç½®
            try{ updateUI(); }catch(e){}
        }
        // æ’­æ”¾å¯¹åº”éŸ³æ•ˆ
        try{
            if(card.h) SFX.heal();
            else if(card.c < 0) SFX.magic();
            else SFX.attack();
        }catch(e){console.warn('SFX play error', e)}

        player.curRes += card.c;
        if(card.h) player.hp = Math.min(player.maxHp, player.hp + card.h);
        
        // æ•™çš‡æœºåˆ¶
        if(boss.n.includes("æ•™çš‡") && player.lastCard === card.n) {
            player.hp -= 12; addLog("è¿åæˆ’å¾‹ï¼š-12HP", "red");
        }
        player.lastCard = card.n;

        // å¦‚æœå¡æœ‰å‰¯ä½œç”¨å‡½æ•°ï¼Œå…ˆæ‰§è¡Œï¼ˆå¯ä¿®æ”¹ playerï¼‰ï¼Œå¹¶æ¥æ”¶è¿”å›çš„é¢å¤–ä¼¤å®³å€¼
        let extraDmg = 0;
        if(typeof card.f === 'function'){
            try { const r = card.f(player); if(typeof r === 'number') extraDmg = r; } catch(e){ console.error(e); }
        }

        // ä¼¤å®³è®¡ç®—
        let dmg;
        if (Array.isArray(card.d)) {
            dmg = player.luckMax ? card.d[1] : Math.floor(Math.random()*(card.d[1]-card.d[0]+1))+card.d[0];
        } else {
            dmg = card.d;
        }

        // åº”ç”¨ä¼¤å®³åŠ æˆ
        dmg = Math.floor(dmg * player.dmgMod);
        if (player.nextCrit) { dmg *= 2; player.nextCrit = false; addLog("è™šæ— ä¹‹è§¦ï¼šä¼¤å®³ç¿»å€ï¼", varColor()); }

        // åŠ ä¸Šå¡ç‰Œè¿”å›çš„é¢å¤–ä¼¤å®³ï¼ˆä¾‹å¦‚ ENFJ çƒˆé˜³ï¼‰
        if(extraDmg) dmg += extraDmg;

        // INFJ è¿œè§åˆ¤å®šï¼šè‹¥è¿œè§è¾¾åˆ° 3ï¼Œåˆ™æœ¬æ¬¡æ”»å‡»ä¼¤å®³ç¿»å€å¹¶å¸è¡€ 15%
        if(player.type === 'INFJ' && (player.vision || 0) >= 3) {
            dmg = Math.floor(dmg * 2);
            const vamp = Math.floor(dmg * 0.15);
            player.hp = Math.min(player.maxHp, player.hp + vamp);
            player.vision = 0;
            addLog("âœ¨ é¢„è¨€å®ç°ï¼šåŒå€ä¼¤å®³å¹¶æ±²å–ç”Ÿå‘½ï¼", "#8e44ad");
            try{ INFJ_SFX.revelation(); }catch(e){}
        }

        // ç»“ç®—æŠ¤ç›¾ï¼ˆBoss æŠ¤ç›¾ä¼˜å…ˆæŠµæŒ¡ï¼‰ï¼Œè‹¥å¡ç‰Œè®¾ç½®äº† nextIgnoreBossShield åˆ™å¿½ç•¥ Boss æŠ¤ç›¾æŠµæŒ¡ä¸€æ¬¡
        if(player.nextIgnoreBossShield) {
            // å¿½ç•¥ä¸€æ¬¡ Boss æŠ¤ç›¾æŠµæŒ¡
            player.nextIgnoreBossShield = false;
            addLog("é€†ä½ï¼šç©¿é€æŠ¤ç›¾ï¼", "#ffd700");
        } else if(boss.shield > 0) {
            let sDmg = Math.min(boss.shield, dmg);
            boss.shield -= sDmg;
            dmg -= sDmg;
        }
        boss.hp -= dmg;
        
        addLog(`ä½¿ç”¨ ${card.n}ï¼Œé€ æˆ ${dmg} ä¼¤å®³`, "#fff");
        document.getElementById('b-img').classList.add('shake');
        setTimeout(()=>document.getElementById('b-img').classList.remove('shake'), 200);

        if(boss.hp <= 0) return winBattle();

        // Boss å›åˆ
        setTimeout(() => {
            boss.turn++;
            // æ‰§è¡Œæ¯å›åˆæ•ˆæœï¼ˆå¦‚è¯…å’’ï¼‰
            player.perTurnEffects.forEach(f => f());

            if(boss.n.includes("éšå£«")) boss.shield = 10;
            if(boss.n.includes("æ­»ç¥")) boss.dmg += 2;
            if(boss.n.includes("æ„šè€…") && boss.turn % 3 === 0) {
                player.curRes = 0; addLog("æ„šè€…æ‰­æ›²äº†èƒ½é‡ï¼", "purple");
            }

            let reduction = (player.tempDamageReduction || 0);
            let finalBossDmg = Math.floor(boss.dmg * player.receivedDmgMod * (1 - reduction));
            // é‡ç½®ä¸´æ—¶å‡ä¼¤
            player.tempDamageReduction = 0;
            // Boss è¿·èŒ«çŠ¶æ€ä¼šä»¤æœ¬å›åˆä¼¤å®³ä¸º 0
            if(boss.isConfused) { finalBossDmg = 0; addLog(`${boss.n} é™·å…¥è¿·èŒ«ï¼šæœ¬å›åˆæ— æ³•é€ æˆä¼¤å®³`, "#8e44ad"); boss.isConfused = false; }
            // ç©å®¶æŠ¤ç›¾ä¼˜å…ˆæŠµæŒ¡
            if(player.shield && player.shield > 0) {
                const blocked = Math.min(player.shield, finalBossDmg);
                player.shield -= blocked;
                finalBossDmg -= blocked;
                addLog(`${boss.n} æ”»å‡»è¢«æŠ¤ç›¾æŠµæŒ¡ï¼š-${blocked} HP`, "#55aaff");
            }
            player.hp -= finalBossDmg;
            // æ ‡è®°æœ¬å›åˆç©å®¶æ˜¯å¦å—åˆ°è¿‡ä¼¤å®³ï¼ˆä¾›å¡ç‰Œåˆ¤å®šä½¿ç”¨ï¼‰
            player.tookDamageThisTurn = finalBossDmg > 0;
            if(finalBossDmg > 0) {
                try { SFX.hurt(); } catch(e){console.warn('SFX hurt error', e); }
                addLog(`${boss.n} åå‡»ï¼š-${finalBossDmg} HP`, "#ff4444");
            }
            
            if(player.hp <= 0) { alert("æ„è¯†ç“¦è§£..."); location.reload(); }
            updateUI();
            initHand();
        }, 400);
    }

    // 2. èƒœåˆ©åéšæœºæŠ½å– 3 ä¸ªå¥–åŠ±
    function winBattle() {
        try{ SFX.heal(); } catch(e){console.warn('SFX heal error', e)}
        addLog("æˆ˜å½¹èƒœåˆ©ï¼æ„è¯†ç»´åº¦æå‡ã€‚", varColor());
        
        // é‡ç½®éƒ¨åˆ†å•åœºçŠ¶æ€
        player.luckMax = false;
        
        const container = document.getElementById('reward-options-container');
        container.innerHTML = '';
        
        // éšæœºæ‰“ä¹±å¹¶å–å‰ 3 ä¸ª
        const shuffled = [...REWARD_POOL].sort(() => 0.5 - Math.random());
        const selections = shuffled.slice(0, 3);
        
        selections.forEach(reward => {
            const btn = document.createElement('div');
            btn.className = 'card-node';
            btn.innerHTML = `<b>${reward.n}</b><br><small>${reward.d}</small>`;
            btn.onclick = () => {
                reward.f(); // æ‰§è¡Œæ•ˆæœ
                level++;
                document.getElementById('reward-layer').style.display = 'none';
                if(level > BOSSES.length) showEnding(); else startLevel();
            };
            container.appendChild(btn);
        });

        document.getElementById('reward-layer').style.display = 'flex';
    }

    // é€šç”¨å¥–åŠ±åº”ç”¨å‡½æ•°ï¼šæ”¯æŒ legacy ç±»å‹ä¸ REWARD_POOL id
    function applyReward(id) {
        // å…¼å®¹æ—§çš„ç®€å•å¥–åŠ± key
        if(id === 'heal') player.hp = Math.min(player.maxHp, player.hp + player.maxHp*0.4);
        else if(id === 'max') { player.maxHp += 30; player.hp += 30; }
        else if(id === 'res') player.curRes += 2;
        else {
            const r = REWARD_POOL.find(x => x.id === id);
            if(r && typeof r.f === 'function') r.f();
        }

        level++;
        document.getElementById('reward-layer').style.display = 'none';
        if(level > BOSSES.length) showEnding(); else startLevel();
    }

    function sacrifice() {
        const cost = player.sacrificeCost || 10; // é»˜è®¤ 10ï¼Œæœ‰å¥–åŠ±åˆ™ä¸º 5
        if(player.hp <= cost) return addLog("ç”Ÿå‘½åŠ›ä¸è¶³ä»¥é‡æ„...", "#555");
        player.hp -= cost;
        addLog(`ğŸ©¸ ç‰ºç‰² ${cost}HP é‡æ„æ€ç»´...`, "#ff4444");
        updateUI();
        initHand();
    }

    function updateUI() {
        document.getElementById('p-hp').innerText = Math.max(0, Math.ceil(player.hp));
        document.getElementById('p-max-hp').innerText = player.maxHp;
        document.getElementById('p-shield').innerText = Math.max(0, Math.ceil(player.shield || 0));
        document.getElementById('res-tag').innerText = `âœ¨ ${player.curRes} ${player.res}`;
        document.getElementById('level-tag').innerText = level;
        document.getElementById('b-name').innerText = boss.n;
        document.getElementById('b-hp-text').innerText = `${Math.max(0, Math.ceil(boss.hp))}/${boss.maxHp}`;
        document.getElementById('b-hp-fill').style.width = Math.max(0, (boss.hp/boss.maxHp*100)) + "%";
        document.getElementById('b-shield-fill').style.width = (boss.shield/boss.maxHp*100) + "%";
        document.getElementById('b-shield-val').innerText = boss.shield;
        // update player shield bar width relative to maxHp
        const pShieldPct = Math.max(0, Math.min(100, ((player.shield||0)/player.maxHp)*100));
        document.getElementById('p-shield-fill').style.width = pShieldPct + "%";
        // æ›´æ–°é€†ä½å¾½ç« æ˜¾ç¤º
        try{
            const inv = document.getElementById('inv-badge');
            if(inv){
                if(player.invUsed) { inv.innerText = 'é€†ä½ï¼šå·²ç”¨'; inv.style.background = 'rgba(255,255,255,0.03)'; inv.style.color = '#888'; }
                else { inv.innerText = 'é€†ä½ï¼šå¯ç”¨'; inv.style.background = 'linear-gradient(90deg,#222,#111)'; inv.style.color = '#ffd700'; }
            }
        }catch(e){}
    }

    function addLog(m, c) {
        const color = c || '#fff';
        const l = document.getElementById('log');
        if(l) {
            try{
                const entry = document.createElement('div');
                entry.style.color = color;
                entry.innerText = `> ${m}`;
                l.appendChild(entry);
                // é™åˆ¶æ—¥å¿—æ¡æ•°ï¼Œé¿å…æ— é™å¢é•¿ï¼ˆä¿ç•™æœ€è¿‘ 120 æ¡ï¼‰
                while(l.children.length > 120) l.removeChild(l.firstChild);
                l.scrollTop = l.scrollHeight;
            }catch(e){ console.warn('log append error', e); }
        } else {
            // å¦‚æœä¸»æ—¥å¿—ä¸å­˜åœ¨ï¼Œå›é€€åˆ°æ§åˆ¶å°è¾“å‡º
            console.log(m);
        }
    }

    function varColor() { return CHARS[player.type].color; }

    // æ˜¾ç¤ºç»“å±€è¦†ç›–å±‚
    function showEnding() {
        document.getElementById('ending-layer').style.display = 'flex';
        addLog('ä½ å·²ç©¿è¶Šæ‰€æœ‰å·²çŸ¥ç»´åº¦ï¼Œæ•…äº‹åœ¨æ­¤å¤„æš‚å‘Šä¸€æ®µè½â€¦â€¦', '#ffd700');
        // å¯é€‰ï¼šå¾®è°ƒèƒŒæ™¯æˆ–éŸ³æ•ˆï¼ˆç•™ç©ºä»¥ä¾¿åç»­æ‹“å±•ï¼‰
    }

    // ç®€å• sleep
    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    // Demo è‡ªåŠ¨åŒ–å·²ç§»é™¤ï¼ˆENFJ æµ‹è¯•ä¸å†è‡ªåŠ¨è¿è¡Œï¼‰

    
</script>
</body>
</html>
```
